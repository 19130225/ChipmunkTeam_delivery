<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>My Map App</title>
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css}" />
<link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body style="border: 0; margin: 0">
	<div id="map"></div>
	<div class="formBlock">
		<form id="form">
			<input type="text" name="start" class="input" id="start"
				placeholder="Choose starting point" /> <input type="text"
				name="end" class="input" id="destination"
				placeholder="Choose starting point" />
			<button style="display: none;" type="submit">Get Directions</button>
		</form>
	</div>

	<script
		th:src="@{https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js}"></script>
	<script
		th:src="@{https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-map.js?key=S8d7L47mdyAG5nHG09dUnSPJjreUVPeC}"></script>
	<script
		th:src="@{https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-routing.js?key=S8d7L47mdyAG5nHG09dUnSPJjreUVPeC}"></script>
	<script>
 // default map layer
    let map = L.map('map', {
        layers: MQ.mapLayer(),
        center: [0, -0],
        zoom: 12
    });
        
// update location
 function updateLocation(lat, lng) {
	 L.marker([lat, lng]).addTo(map);
	 map.setView([lat, lng], 13); // Thay đổi tọa độ trung tâm của bản đồ
 }
 //
 navigator.geolocation.getCurrentPosition((position) => {
	 const {latitude, longitude} = position.coords;
	 L.marker([latitude, longitude]).addTo(map); // Tạo Marker tại vị trí này
	 map.setView([latitude, longitude], 13); // Phóng to bản đồ đến vị trí này
	 // Sử dụng fetch API để cập nhật thông tin vị trí từ địa chỉ IP
	 setInterval(() => {
		 fetch('https://geoip-db.com/json/')
				 .then((response) => response.json())
				 .then((data) => {
					 const {latitude, longitude} = data; // Lấy tọa độ từ kết quả trả về
					 updateLocation(latitude, longitude); // Cập nhật vị trí mới
					 map.setView([latitude, longitude], 13); // Cập nhật vị trí hiển thị trên bản đồ
				 })
				 .catch((error) => {
					 console.error(error);
				 });
	 }, 5000); // Thực hiện cập nhật mỗi 5 giây
 }, (error) => {
	 console.error(error);
	 // Sử dụng fetch API để cập nhật thông tin vị trí từ địa chỉ IP
	 setInterval(() => {
		 fetch('https://geoip-db.com/json/')
				 .then((response) => response.json())
				 .then((data) => {
					 const {latitude, longitude} = data; // Lấy tọa độ từ kết quả trả về
					 updateLocation(latitude, longitude); // Cập nhật vị trí mới
					 map.setView([latitude, longitude], 13); // Cập nhật vị trí hiển thị trên bản đồ
				 })
				 .catch((error) => {
					 console.error(error);
				 });
	 }, 5000); // Thực hiện cập nhật mỗi 5 giây
 });
 //
        function runDirection(start, end) {
            
            // recreating new map layer after removal
            map = L.map('map', {
                layers: MQ.mapLayer(),
                center: [0, 0],
                zoom: 12
            });
            
            var dir = MQ.routing.directions();

            dir.route({
                locations: [
                    start,
                    end
                ]
            });
        

            CustomRouteLayer = MQ.Routing.RouteLayer.extend({
                createStartMarker: (location) => {
                    var custom_icon;
                    var marker;

                    custom_icon = L.icon({
                       iconUrl: 'img/blue.png',

                        iconSize: [20, 29],
                        iconAnchor: [10, 29],
                        popupAnchor: [0, -29]
                    });

                    marker = L.marker(location.latLng, {icon: custom_icon}).addTo(map);

                    return marker;
                },

                createEndMarker: (location) => {
                    var custom_icon;
                    var marker;

                    custom_icon = L.icon({
                        iconUrl: 'img/red.png',
                        iconSize: [20, 29],
                        iconAnchor: [10, 29],
                        popupAnchor: [0, -29]
                    });

                    marker = L.marker(location.latLng, {icon: custom_icon}).addTo(map);

                    return marker;
                }
            });
            
            map.addLayer(new CustomRouteLayer({
                directions: dir,
                fitBounds: true
            })); 
        }


    // function that runs when form submitted
    function submitForm(event) {
        event.preventDefault();

        // delete current map layer
        map.remove();

        // getting form data
        start = document.getElementById("start").value;
        end = document.getElementById("destination").value;

        // run directions function
        runDirection(start, end);

        // reset form
        document.getElementById("form").reset();
    }

    // asign the form to form variable
    const form = document.getElementById('form');

    // call the submitForm() function when submitting the form
    form.addEventListener('submit', submitForm);
    </script>
</body>
</html>
