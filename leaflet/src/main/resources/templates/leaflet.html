<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>My Map App</title>
<link rel="stylesheet"
	th:href="@{https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css}" />
<link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body style="border: 0; margin: 0">
	<div id="map">
		<div class="formBlock1" style="margin-left: 1300px;">
			<button onclick="showAlert()"><img style="width: 46px;height: 46px;" src="img/trash.png" alt=""></button>
		</div>
	<div class="formBlock">
		<form id="form">
			<div id="error-message"></div><br>
			<input type="text" name="start" class="input" id="start"
				placeholder="Choose starting point" /> <input type="text"
				name="end" class="input" id="destination"
				placeholder="Choose starting point" />
			<button style="display: none;" type="submit">Get Directions</button>
		</form>
	</div>
	</div>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
	<script
		src="https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-map.js?key=S8d7L47mdyAG5nHG09dUnSPJjreUVPeC"></script>
	<script
		src="https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-routing.js?key=S8d7L47mdyAG5nHG09dUnSPJjreUVPeC"></script>
	<script>
 // default map layer
    let map = L.map('map', {
        layers: MQ.mapLayer(),
        center: [0, -0],
        zoom: 12
    });
        
// update location
 function updateLocation(lat, lng) {
	 L.marker([lat, lng]).addTo(map);
	 map.setView([lat, lng], 13); // Thay đổi tọa độ trung tâm của bản đồ
 }
 //
 navigator.geolocation.getCurrentPosition((position) => {
	 const {latitude, longitude} = position.coords;
	 L.marker([latitude, longitude]).addTo(map); // Tạo Marker tại vị trí này
	 map.setView([latitude, longitude], 13); // Phóng to bản đồ đến vị trí này
	 // Sử dụng fetch API để cập nhật thông tin vị trí từ địa chỉ IP
	 setInterval(() => {
		 fetch('https://geoip-db.com/json/')
				 .then((response) => response.json())
				 .then((data) => {
					 const {latitude, longitude} = data; // Lấy tọa độ từ kết quả trả về
					 updateLocation(latitude, longitude); // Cập nhật vị trí mới
					 map.setView([latitude, longitude], 13); // Cập nhật vị trí hiển thị trên bản đồ
				 })
				 .catch((error) => {
					 console.error(error);
				 });
	 }, 5000); // Thực hiện cập nhật mỗi 5 giây
 }, (error) => {
	 console.error(error);
	 // Sử dụng fetch API để cập nhật thông tin vị trí từ địa chỉ IP
	 setInterval(() => {
		 fetch('https://geoip-db.com/json/')
				 .then((response) => response.json())
				 .then((data) => {
					 const {latitude, longitude} = data; // Lấy tọa độ từ kết quả trả về
					 updateLocation(latitude, longitude); // Cập nhật vị trí mới
					 map.setView([latitude, longitude], 13); // Cập nhật vị trí hiển thị trên bản đồ
				 })
				 .catch((error) => {
					 console.error(error);
				 });
	 }, 5000); // Thực hiện cập nhật mỗi 5 giây
 });
 //
 function runDirection(start, end) {
	 // create a new map layer
	 map = L.map('map', {
		 layers: MQ.mapLayer({
			 key: 'FPEf1w0pVCwT6lGp6U7S9jLKXtqwunyx'
		 }),
		 center: [10.774450, 106.700232],
		 zoom: 13
	 });

	 // create a directions object
	 const dir = MQ.routing.directions();

	 // set the from and to locations
	 dir.route({
		 locations: [
			 { street: start },
			 { street: end }
		 ]
	 });

	 // create a customized route layer
	 const CustomRouteLayer = MQ.Routing.RouteLayer.extend({
		 createStartMarker: (location) => {
			 var custom_icon = L.icon({
				 iconUrl: 'img/placeholder.png',
				 iconSize: [20, 29],
				 iconAnchor: [10, 29],
				 popupAnchor: [0, -29]
			 });

			 var marker = L.marker(location.latLng, { icon: custom_icon }).addTo(map);

			 return marker;
		 },

		 createEndMarker: (location) => {
			 var custom_icon = L.icon({
				 iconUrl: 'img/placeholder (1).png',
				 iconSize: [20, 29],
				 iconAnchor: [10, 29],
				 popupAnchor: [0, -29]
			 });

			 var marker = L.marker(location.latLng, { icon: custom_icon }).addTo(map);

			 return marker;
		 },

		 createLine: (features, options) => {
			 var line = L.geoJSON(features, {
				 style: {
					 color: '#0096d6',
					 weight: 6
				 }
			 });

			 return line;
		 }
	 });

	 // add the route layer to the map
	 map.addLayer(new CustomRouteLayer({
		 directions: dir,
		 fitBounds: true
	 }));

	 // retrieve the route data from the MapQuest Directions API
	 const url = `https://www.mapquestapi.com/directions/v2/route?key=FPEf1w0pVCwT6lGp6U7S9jLKXtqwunyx&from=${start}&to=${end}`;

	 fetch(url)
			 .then(response => {
				 if (response.status==400) {
					 throw new Error(`Failed to retrieve route data `);
				 }
				 return response.json();
			 })
			 .then(data => {
				 // get the maneuver data for the route
				 const maneuvers = data.route.legs[0].maneuvers;

				 // create an array of instructions for the route
				 const instructions = maneuvers.map(maneuver => maneuver.narrative);
				 const direction = maneuvers.map(maneuver => maneuver.direction);
				 // display the instructions on the page
				 const instructionsContainer = document.getElementById('error-message');
				 instructionsContainer.innerHTML = 'Arrdress' + direction;
				 instructions.forEach(instruction => {
					 const li = document.createElement('li');
					 li.classList.add('li_derec');
					 if (instruction.indexOf("Turn left") !== -1) {

						 instruction = instruction.replace("Turn left", "<img class='img_icon_instruction' src='https://th.bing.com/th/id/R.f7484f0b227841ce23b09630e5bab0c1?rik=3eFDi3ukctQV8Q&riu=http%3a%2f%2ficons.iconarchive.com%2ficons%2ficonsmind%2foutline%2f512%2fTurn-Left-icon.png&ehk=sfDp7m4o11nekZiESdOyvTBdsTiH9CSHNrjfcpPCH0Y%3d&risl=&pid=ImgRaw&r=0'> Turn left");

					 }

					 if (instruction.indexOf("Turn right") !== -1) {

						 instruction = instruction.replace("Turn right", "<img class='img_icon_instruction' src='img/turn-right.png'> Turn right");

					 }
					 if (instruction.indexOf("Keep right") !== -1) {

						 instruction = instruction.replace("Keep right", "<img class='img_icon_instruction' src='img/top-right.png'> Keep right");

					 }
					 if (instruction.indexOf("Keep left") !== -1) {

						 instruction = instruction.replace("Keep left", "<img class='img_icon_instruction' src='img/340481594_885769662488655_4930446522493437372_n.jpg'> Keep left");

					 }
					 if (instruction.indexOf("Continue") !== -1 || instruction.indexOf("Head") !== -1) {

						 instruction = instruction.replace("Continue", "<img class='img_icon_instruction' src='img/up-arrow.png'> Continue");
						 instruction = instruction.replace("Head", "<img class='img_icon_instruction' src='img/up-arrow.png'> Head");

					 }
					 li.innerHTML = instruction;
					 instructionsContainer.appendChild(li);

				 });
			 })
			 .catch(error => {
				 console.error(error);
				 alert('There was an error retrieving the route data. Please try again later.');
			 });
 }

    // function that runs when form submitted
    function submitForm(event) {
        event.preventDefault();

        // delete current map layer
        map.remove();

        // getting form data
        start = document.getElementById("start").value;
        end = document.getElementById("destination").value;

        // run directions function
        runDirection(start, end);

        // reset form
        document.getElementById("form").reset();
    }

    // asign the form to form variable
    const form = document.getElementById('form');

    // call the submitForm() function when submitting the form
    form.addEventListener('submit', submitForm);
    </script>

</body>
</html>
